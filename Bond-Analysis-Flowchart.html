<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bond Evaluation Flowchart - Quick Analysis Tool | BondMetrics Pro</title>
    <meta name="description"
        content="Interactive bond analysis flowchart and decision tree. Quickly identify dealbreakers in fixed income securities with our 7-step triage system.">
    <meta name="keywords"
        content="bond flowchart, investment decision tree, bond triage, fixed income checklist, bond analysis tool">
    <meta property="og:title" content="Bond Analysis Flowchart - BondMetrics Pro">
    <meta property="og:description" content="Interactive decision tree for quick bond evaluation.">
    <meta property="og:type" content="website">
    <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "WebApplication",
      "name": "Bond Analysis Flowchart",
      "applicationCategory": "FinanceApplication",
      "description": "An interactive flowchart that guides users through a 7-step triage process to evaluate bond quality."
    }
    </script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="css/global.css">
    <style>
        .phase-step {
            position: relative;
            padding-bottom: 3rem;
        }

        .phase-step::before {
            content: '';
            position: absolute;
            left: 20px;
            top: 40px;
            bottom: 0;
            width: 2px;
            background: var(--border);
            z-index: 0;
        }

        .phase-step:last-child::before {
            display: none;
        }

        .phase-indicator {
            position: relative;
            z-index: 1;
            display: flex;
            align-items: center;
            gap: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .phase-circle {
            width: 42px;
            height: 42px;
            border-radius: 50%;
            background: white;
            border: 2px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            color: var(--text-muted);
            transition: var(--transition);
        }

        .phase-step.active .phase-circle {
            background: var(--primary);
            border-color: var(--primary);
            color: white;
            box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.2);
        }

        .gate-card {
            margin-left: 3.5rem;
            background: white;
            padding: 1.5rem;
            border-radius: var(--radius);
            border: 1px solid var(--border);
            margin-bottom: 1rem;
            transition: var(--transition);
        }

        .gate-card.locked {
            opacity: 0.5;
            background: #f8fafc;
        }

        .gate-card.pass {
            border-left: 6px solid var(--success);
        }

        .gate-card.fail {
            border-left: 6px solid var(--error);
        }

        .gate-card.caution {
            border-left: 6px solid var(--warning);
        }

        .gate-meta {
            font-size: 0.75rem;
            color: var(--text-muted);
            margin-top: 0.5rem;
            padding-top: 0.5rem;
            border-top: 1px solid #f1f5f9;
        }

        .stop-sign {
            margin-left: 3.5rem;
            background: rgba(239, 68, 68, 0.1);
            color: #dc2626;
            padding: 1rem;
            border-radius: 12px;
            font-weight: 700;
            text-align: center;
            border: 1px dashed #ef4444;
        }

        .decision-hero {
            padding: 3rem;
            border-radius: var(--radius-lg);
            text-align: center;
            color: white;
            margin-top: 2rem;
        }

        .decision-hero.EXECUTE {
            background: var(--success);
        }

        .decision-hero.EXECUTE-CAUTION {
            background: var(--warning);
        }

        .decision-hero.STOP {
            background: var(--error);
        }
    </style>
</head>

<body>
    <script src="js/navigation.js"></script>

    <div class="container" style="padding-top: 3rem;">
        <div class="grid grid-cols-3">
            <div class="card">
                <h3 class="card-title">Bond Details</h3>
                <div class="form-group">
                    <label>Market Price - $</label>
                    <input type="number" id="bondPrice" value="950">
                </div>
                <div class="form-group">
                    <label>Face Value - $</label>
                    <input type="number" id="faceValue" value="1000">
                </div>
                <div class="form-group">
                    <label>Coupon Rate - %</label>
                    <input type="number" id="couponRate" value="5">
                </div>
                <div class="form-group">
                    <label>Maturity (yrs)</label>
                    <input type="number" id="yearsToMaturity" value="10">
                </div>
            </div>

            <div class="card">
                <h3 class="card-title">Economic Context</h3>
                <div class="form-group">
                    <label>Required Yield - %</label>
                    <input type="number" id="requiredYield" value="5.5">
                </div>
                <div class="form-group">
                    <label>Credit Spread - %</label>
                    <input type="number" id="creditSpread" value="1.5">
                </div>
                <div class="form-group">
                    <label>Coupon Type</label>
                    <select id="couponType">
                        <option value="fixed">Fixed Rate</option>
                        <option value="floating">Floating Rate</option>
                        <option value="zero">Zero Coupon</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Rating</label>
                    <select id="creditRating">
                        <option>AAA</option>
                        <option>AA</option>
                        <option>A</option>
                        <option selected>BBB</option>
                        <option>BB</option>
                        <option>B</option>
                    </select>
                </div>
            </div>

            <div class="card">
                <h3 class="card-title">Risk Flags</h3>
                <div class="form-group">
                    <label>Rate Outlook</label>
                    <select id="rateOutlook">
                        <option value="falling">Falling Rates</option>
                        <option value="stable" selected>Neutral</option>
                        <option value="rising">Rising Rates</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Duration Match</label>
                    <select id="durationMatch">
                        <option value="good" selected>Aligned</option>
                        <option value="moderate">Neutral</option>
                        <option value="poor">Misaligned</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Liquidity</label>
                    <select id="liquidity">
                        <option value="high" selected>High (Liquid)</option>
                        <option value="moderate">Moderate</option>
                        <option value="low">Low (Illiquid)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Is Callable?</label>
                    <select id="isCallable">
                        <option value="false">No</option>
                        <option value="true">Yes</option>
                    </select>
                </div>
            </div>
        </div>

        <button onclick="analyzeFlowchart()" class="btn btn-primary"
            style="margin-top: 2rem; width: 100%; height: 60px; font-size: 1.125rem;">
            Run Sequential Veto Audit
        </button>

        <div id="errorContainer"></div>

        <div class="results-section" id="flowchartResults" style="display: none; max-width: 800px; margin: 4rem auto;">
            <div id="phase1" class="phase-step active"></div>
            <div id="phase2" class="phase-step"></div>
            <div id="phase3" class="phase-step"></div>
            <div id="phase4"></div>
        </div>

        <div style="height: 100px;"></div>
    </div>

    <script src="js/api-client.js"></script>
    <script>
        async function analyzeFlowchart() {
            const resultsSection = document.getElementById('flowchartResults');
            const errorContainer = document.getElementById('errorContainer');
            const btn = document.querySelector('button[onclick="analyzeFlowchart()"]');

            errorContainer.innerHTML = '';
            btn.disabled = true;
            btn.innerHTML = '<span>Triage in Progress...</span>';

            try {
                const data = {
                    bondPrice: parseFloat(document.getElementById('bondPrice').value),
                    faceValue: parseFloat(document.getElementById('faceValue').value),
                    couponRate: parseFloat(document.getElementById('couponRate').value),
                    yearsToMaturity: parseFloat(document.getElementById('yearsToMaturity').value),
                    requiredYield: parseFloat(document.getElementById('requiredYield').value),
                    creditSpread: parseFloat(document.getElementById('creditSpread').value),
                    couponType: document.getElementById('couponType').value,
                    isCallable: document.getElementById('isCallable').value === 'true',
                    rateOutlook: document.getElementById('rateOutlook').value,
                    durationMatch: document.getElementById('durationMatch').value
                };

                const result = await BondAPI.evaluateFlowchart(data);
                const { metrics, gates, decision, riskFlags } = result;

                // Phase 1: Fair Price
                let html1 = `
                    <div class="phase-indicator">
                        <div class="phase-circle">1</div>
                        <h3 style="margin: 0;">Fair Price Gates</h3>
                    </div>
                    <div class="gate-card ${gates.gate1aStatus}">
                        <div style="font-weight: 700;">Market vs Fair Price</div>
                        <div class="gate-meta">Market: $${data.bondPrice.toFixed(2)} | Fair: $${metrics.fairPrice.toFixed(2)}</div>
                    </div>
                    <div class="gate-card ${gates.gate1bStatus}">
                        <div style="font-weight: 700;">Credit Spread Integrity</div>
                        <div class="gate-meta">Spread: ${data.creditSpread.toFixed(2)}% (Target: >1.00%)</div>
                    </div>
                `;
                if (!gates.phase1Pass) html1 += `<div class="stop-sign animate-fade-in">⏹️ VETO: Phase 1 Fail. Stop Analysis.</div>`;
                document.getElementById('phase1').innerHTML = html1;

                // Phase 2: Real Money
                const p2Status = gates.phase1Pass ? 'active' : '';
                document.getElementById('phase2').className = `phase-step ${p2Status}`;
                let html2 = `
                    <div class="phase-indicator">
                        <div class="phase-circle">2</div>
                        <h3 style="margin: 0;">Real Money Gates</h3>
                    </div>
                    <div class="gate-card ${!gates.phase1Pass ? 'locked' : gates.gate2aStatus}">
                        <div style="font-weight: 700;">Real Yield Protection</div>
                        <div class="gate-meta">Inflation-Adjusted Return: ${(metrics.realYield * 100).toFixed(2)}%</div>
                    </div>
                    <div class="gate-card ${!gates.phase1Pass ? 'locked' : gates.gate2bStatus}">
                        <div style="font-weight: 700;">Income Target Alignment</div>
                        <div class="gate-meta">Current Yield: ${metrics.currentYield.toFixed(2)}% vs ${data.requiredYield}%</div>
                    </div>
                `;
                if (gates.phase1Pass && !gates.phase2Pass) html2 += `<div class="stop-sign animate-fade-in">⏹️ VETO: Phase 2 Fail. Stop Analysis.</div>`;
                document.getElementById('phase2').innerHTML = html2;

                // Phase 3: Risk Filters
                const p3Status = (gates.phase1Pass && gates.phase2Pass) ? 'active' : '';
                document.getElementById('phase3').className = `phase-step ${p3Status}`;
                document.getElementById('phase3').innerHTML = `
                    <div class="phase-indicator">
                        <div class="phase-circle">3</div>
                        <h3 style="margin: 0;">Risk Filter Gates</h3>
                    </div>
                    <div class="gate-card ${!p3Status ? 'locked' : gates.gate3aStatus}">
                        <div style="font-weight: 700;">Interest Rate Mismatch</div>
                        <div class="gate-meta">Type: ${data.couponType} | Outlook: ${data.rateOutlook}</div>
                    </div>
                    <div class="gate-card ${!p3Status ? 'locked' : gates.gate3bStatus}">
                        <div style="font-weight: 700;">Duration Alignment</div>
                        <div class="gate-meta">Match Quality: ${data.durationMatch}</div>
                    </div>
                    <div class="gate-card ${!p3Status ? 'locked' : gates.gate3cStatus}">
                        <div style="font-weight: 700;">Callability Exposure</div>
                        <div class="gate-meta">Callable: ${data.isCallable}</div>
                    </div>
                `;

                // Phase 4: Decision
                const decisionClass = decision.replace(/ /g, '-');
                document.getElementById('phase4').innerHTML = `
                    <div class="decision-hero ${decisionClass} animate-fade-in" style="margin-left: 3.5rem;">
                        <h2 style="color: white; font-size: 2.5rem; font-weight: 700; margin-bottom: 0.5rem;">${decision}</h2>
                        <p style="opacity: 0.9;">${decision.includes('STOP') ? 'Critical requirements not met.' : 'Sequential validation successful.'}</p>
                    </div>
                `;

                resultsSection.style.display = 'block';
                resultsSection.scrollIntoView({ behavior: 'smooth' });

            } catch (error) {
                errorContainer.innerHTML = `<div class="badge badge-error" style="display: block; padding: 1rem;">Server Error: ${error.message}</div>`;
                resultsSection.style.display = 'block';
            } finally {
                btn.disabled = false;
                btn.innerText = 'Run Sequential Veto Audit';
            }
        }
    </script>
    <script src="js/footer.js"></script>
</body>

</html>